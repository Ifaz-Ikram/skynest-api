# üè® SkyNest Hotel Database ‚Äî Team Handover (PostgreSQL)

## üìò Project Overview
**System:** Hotel Reservation and Guest Services Management  
**Database:** PostgreSQL 16 (compatible with 13+)  
**Schema:** `public`  
**Role:** Member 1 ‚Äî *Database & Reports Lead*  
**Project Group:** 40  

The SkyNest database implements all SRS requirements for:
- Multi-branch hotel management (Colombo, Kandy, Galle)
- Room and service booking with advance payments
- Prevention of double booking and unpaid checkouts
- Automatic room state management (Available ‚Üî Occupied)
- Billing, partial payments, and service usage tracking
- Refund automation based on cancellation timing
- Five analytical reports directly generated by SQL views

---

## üß± 1Ô∏è‚É£ Database Scope & Entities
| Category | Entities / Purpose |
|-----------|-------------------|
| **Reference** | `branch`, `room_type`, `service_catalog` ‚Äî static lookup tables |
| **Core Operations** | `room`, `guest`, `booking`, `service_usage`, `payment`, `invoice` |
| **Users & RBAC** | `user_account`, `employee`, `customer` |
| **Audit / Refunds** | `payment_adjustment`, optional `audit_log` |
| **Reports (Views)** | `vw_occupancy_by_day`, `vw_billing_summary`, `vw_service_usage_detail`, `vw_branch_revenue_monthly`, `vw_service_monthly_trend` |

Each table includes proper foreign-key constraints, indexes for query speed, and CHECK conditions to enforce integrity.

---

## ‚öôÔ∏è 2Ô∏è‚É£ Setup Instructions

### Option A ‚Äî PostgreSQL CLI
```bash
createdb skynest
psql -d skynest -f skynest_schema.sql
```

### Option B ‚Äî DBeaver GUI
1. Create a new database named **skynest**.
2. Open your exported `skynest_schema.sql`.
3. Run **Execute SQL Script** (CTRL+Enter or ‚ñ∂ button).
4. Wait until ‚ÄúScript executed successfully‚Äù appears.

### ‚úÖ Optional
Enable GiST extension manually if it fails to auto-install:
```sql
CREATE EXTENSION IF NOT EXISTS btree_gist;
```

After import, you can inspect the schema using:
```sql
\dt        -- list tables (in psql)
SELECT * FROM branch;
```

---

## üîê 3Ô∏è‚É£ Role & Access Model
| Role | Description | Scope |
|------|--------------|--------|
| **Admin** | Manages global configuration, users, and branches | All branches |
| **Manager** | Oversees operations of a specific branch | Per branch |
| **Receptionist** | Creates bookings, check-ins, and check-outs | Per branch |
| **Accountant** | Handles payments, refunds, and billing | Per branch |
| **Customer** | Guest login to view bookings & payments | Personal only |

Authentication is handled by `user_account`.  
Authorization and filtering (by `branch_id` or `guest_id`) are handled by the backend using relationships:
- Staff: `user_account ‚Üí employee ‚Üí branch`
- Customer: `user_account ‚Üí customer ‚Üí guest`

---

## üíæ 4Ô∏è‚É£ Schema Highlights
## üïí 4.1Ô∏è‚É£ Booking & Pre-Booking Creation Timestamps
Both `booking` and `pre_booking` now record when they were first created.

| Table | Column | Description | Default |
|--------|---------|--------------|----------|
| `booking` | `created_at timestamptz` | Time the confirmed booking was created | `now()` |
| `pre_booking` | `created_at timestamptz` | Time the initial pre-booking request was logged | `now()` |

### Behavior
- Added via migration; existing rows were backfilled (7 days before check-in for realism).  
- Auto-filled for all future inserts using PostgreSQL‚Äôs `DEFAULT now()`.  
- Indexed (`idx_booking_created_at`, `idx_pre_booking_created_at`) for fast reports.

### Usage Examples
```sql
-- Bookings created today
SELECT booking_id, guest_id, created_at
FROM booking
WHERE created_at::date = CURRENT_DATE
ORDER BY created_at DESC;

-- Pre-bookings created in the last 7 days
SELECT pre_booking_id, guest_id, created_at
FROM pre_booking
WHERE created_at >= now() - interval '7 days'
ORDER BY created_at DESC;
```
These timestamps are useful for daily summary reports, business audits, and backend dashboard filters.


### Branch & Rooms
- Each `branch` hosts multiple `room`s of varying `room_type`s.
- `room.status` can be *Available*, *Occupied*, or *Maintenance*.
- `branch_id + room_number` is **unique**, preventing duplicates.

### Guests & Users
- Every hotel guest has one `guest` record (contact info).
- If they register, they gain a `user_account` and `customer` record.
- Employees (Managers, Receptionists, Accountants) are linked to `user_account` via the `employee` table.

### Bookings
- Linked to both `guest` and `room`.
- Includes: `check_in_date`, `check_out_date`, `booked_rate`, `advance_payment`, taxes, discounts, etc.
- Uses an **EXCLUDE GiST constraint** to prevent overlapping bookings on the same room.
- Status lifecycle: `Booked ‚Üí Checked_In ‚Üí Checked_Out / Cancelled`.

### Payments
- Stored in `payment` (instalments supported).
- Refunds are stored separately in `payment_adjustment` (never negative payments).
- `advance_payment` is part of the booking but reflected in total payments.

### Services
- Defined in `service_catalog` (Room Service, Spa, Laundry, etc.).
- Actual usage stored in `service_usage` with `qty` √ó `unit_price_at_use`.
- Linked directly to `booking`, not `room`, to simplify reporting.

### Reports
- Each required report is implemented as a **view** for easy backend/API integration (see section 9).

---

## üßÆ 5Ô∏è‚É£ Business Logic (Triggers + Functions)

| Business Rule | Implemented By |
|----------------|----------------|
| Prevent double booking | `no_overlapping_bookings` (GiST constraint on `stay` range) |
| Advance must be ‚â• 10% | `booking_min_advance_guard` trigger + CHECK |
| Full/partial refund automation | `trg_refund_advance_policy` trigger |
| Block checkout with unpaid balance | `trg_no_checkout_with_dues` trigger |
| Flip room status to *Occupied* / *Available* | `trg_room_status_checkin`, `trg_room_status_checkout` |
| Auto-calculate totals | helper functions: `fn_room_charges`, `fn_service_charges`, `fn_total_paid`, `fn_total_refunds`, `fn_bill_total`, `fn_balance_due` |

All triggers are idempotent and safe to re-load.

---

## üí∞ 6Ô∏è‚É£ Cancellation & Refund Logic
1. Guest pays advance (‚â•10%) when booking.  
2. If **Cancelled ‚â• 2 days** before check-in ‚Üí full refund.  
3. If **Cancelled < 2 days** ‚Üí refund = *advance ‚àí 10% fee*.  
4. Refunds auto-insert into `payment_adjustment`.

This keeps `payment` for inflow and `payment_adjustment` for outflow, simplifying audit and reporting.

---

## üìä 7Ô∏è‚É£ Reporting Views

| View | Description |
|------|--------------|
| `vw_occupancy_by_day` | Room occupancy per branch/date |
| `vw_billing_summary` | Full billing with balances and unpaid guests |
| `vw_service_usage_detail` | Detailed service usage per booking |
| `vw_branch_revenue_monthly` | Monthly revenue (room + services + tax) |
| `vw_service_monthly_trend` | Top-used services and customer preferences |

All are read-only and used directly by frontend dashboards.

---

## üîß 8Ô∏è‚É£ Backend Integration Hints

### Login Flow
```sql
SELECT user_id, username, password_hash, role
FROM user_account WHERE username = $1;
```
‚Üí Backend verifies password (bcrypt).  
Then joins based on `role`:
- If `Customer` ‚Üí `JOIN customer USING(user_id) JOIN guest USING(guest_id)`
- If Staff ‚Üí `JOIN employee USING(user_id) JOIN branch USING(branch_id)`

### Booking APIs
- `POST /booking` inserts into `booking` (triggers handle advance + validation).
- `PATCH /booking/:id/status` triggers room status flips and refund logic.
- `GET /reports/:view` maps directly to SQL views above.

### Security Best Practices
- Always use **parameterized SQL** (no string concatenation).  
- Wrap multi-table operations (booking + payment + usage) in **transactions**.  
- Backend never manipulates triggers or functions directly.

---

## üß™ 9Ô∏è‚É£ Testing Checklist

| Test | Expected Result |
|------|-----------------|
| Insert overlapping booking | ‚ùå Error: ‚Äúno_overlapping_bookings‚Äù |
| Advance < 10% | ‚ùå Error: ‚Äúadvance_payment below 10%‚Äù |
| Check-in | ‚úÖ `room.status` ‚Üí Occupied |
| Partial payment + balance check | ‚úÖ `fn_balance_due()` shows remaining |
| Checkout before dues cleared | ‚ùå Blocked by trigger |
| Cancel booking 3 days early | ‚úÖ Refund = full advance |
| Cancel booking 1 day early | ‚úÖ Refund = 90% of advance |
| Run all 5 reports | ‚úÖ Return correct results without errors |

---

## üß∞ 10Ô∏è‚É£ Maintenance Commands

Rebuild schema from scratch:
```bash
dropdb skynest
createdb skynest
psql -d skynest -f skynest_schema.sql
```

Backup schema only:
```bash
pg_dump -s -U postgres skynest > skynest_structure.sql
```

Backup with data:
```bash
pg_dump -U postgres skynest > skynest_full.sql
```

---

## üßæ 11Ô∏è‚É£ Troubleshooting Guide

| Issue | Cause | Fix |
|--------|--------|-----|
| ‚ÄúNo operator class for GiST‚Äù | `btree_gist` extension missing | Run `CREATE EXTENSION btree_gist;` |
| ‚ÄúCannot drop column ‚Ä¶ depends on view‚Äù | A report view uses that column | Drop dependent view first, then alter |
| ‚ÄúTrigger function not found‚Äù | Partial import | Ensure full script executed top-to-bottom |
| ‚ÄúNo employees in data‚Äù | Seed missing | Run provided employee insert script |
| ‚ÄúForeign key violation‚Äù | Booking references missing guest/room | Check seed order or disable temporarily for import |

---

## üß© 12Ô∏è‚É£ Deliverables Summary

| File | Description |
|------|--------------|
| `skynest_schema.sql` | Full schema + data + triggers + functions + reports |
| `README.md` | Setup, test, and handover guide |
| `ERD_SkyNest.dbml` | DBML code (importable into dbdiagram.io) |
| *(optional)* `ERD_SkyNest.png` | Exported visual diagram |

---

## üë• 13Ô∏è‚É£ Team Hand-off Matrix

| Member | Role | Responsibility |
|---------|------|----------------|
| Member 1 | Database & Reports Lead | Schema, triggers, reports, data validation |
| Member 2 | Backend/API Lead | Connect DB, build REST endpoints, handle auth |
| Member 3 | Frontend/UI | Render dashboards, booking screens, reports |
| Member 4 | Security/QA | Validate triggers, role access, ACID compliance |
| Member 5 | DevOps/Docs | Deploy DB in Docker/Postgres, maintain backups |

---

## üéì 14Ô∏è‚É£ Viva Notes (for Database Lead)
Be ready to explain:
- Why you used **PostgreSQL** (ACID compliance, range types, triggers).
- How `daterange` + GiST prevents overlaps.
- Why refunds are separated from payments.
- Why DB handles validation (advance %, refunds) rather than frontend.
- How reports use aggregation and joins.
- How you verified data realism (3 branches, 10+ rooms, 8 bookings, etc.).

---

‚úÖ **Your deliverables are now complete.**  
Hand this README, your `.sql`, and your `.dbml` to your team ‚Äî  
the backend can directly connect, and QA can test every rule live.

